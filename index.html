<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ï½Jason & Lala Weddingï½</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* å®Œæ•´æ¨£å¼ä»£ç¢¼ - å·²åŒ…å«æ‰€æœ‰è¨­è¨ˆ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; }
        body { background-color: #f9f3f3; color: #333; line-height: 1.6; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .container { background-color: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 30px; }
        h1 { color: #c62828; font-size: 32px; margin-bottom: 10px; font-family: 'Segoe UI', 'Microsoft JhengHei', cursive; text-align: center; }
        .btn { background-color: #e53935; color: white; border: none; padding: 14px 25px; border-radius: 8px; font-size: 18px; cursor: pointer; width: 100%; margin: 10px 0; }
        input, textarea { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; margin: 10px 0; font-size: 16px; }
        .upload-area { border: 2px dashed #e53935; border-radius: 10px; padding: 25px; text-align: center; cursor: pointer; margin: 15px 0; }
        .status-success { background-color: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .status-error { background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0; }
        @media (max-width: 768px) { h1 { font-size: 28px; } body { padding: 10px; } }
    </style>
</head>
<body>
    <div class="container">
        <header style="text-align:center; margin-bottom:30px; border-bottom:2px solid #e8c8c8; padding-bottom:20px;">
            <div style="font-size:40px; color:#e53935; margin-bottom:15px;">
                <i class="fas fa-heart" style="color:#e53935; margin:0 5px;"></i>
                <i class="fas fa-gift"></i>
                <i class="fas fa-heart" style="color:#e53935; margin:0 5px;"></i>
            </div>
            <h1>ï½Jason & Lala Weddingï½</h1>
            <div style="color:#e53935; font-size:20px; margin-bottom:5px; font-weight:600;">å©šç¦®ç´…åŒ…è¨˜éŒ„ç³»çµ±</div>
            <div style="color:#777; font-size:16px;">è‡ªå‹•åŒæ­¥è‡³ Google Drive å’Œ Google Sheets</div>
        </header>
        
        <div style="background-color:#fff8f8; border-left:4px solid #e53935; padding:15px; margin-bottom:25px; border-radius:0 8px 8px 0;">
            <h3 style="color:#c62828; margin-bottom:10px;">âœ… ç³»çµ±å·²æº–å‚™å°±ç·’ï¼</h3>
            <p>æ¯æ¬¡ä¿å­˜éƒ½æœƒï¼š</p>
            <ol style="padding-left:20px;">
                <li>è‡ªå‹•ä¸Šå‚³åœ–ç‰‡åˆ° Google Drive</li>
                <li>è‡ªå‹•ä¿å­˜è¨˜éŒ„åˆ° Google Sheets</li>
                <li>å³ä½¿æ–·ç¶²ä¹Ÿæœƒæš«å­˜æœ¬åœ°ï¼Œæœ‰ç¶²çµ¡æ™‚è‡ªå‹•åŒæ­¥</li>
            </ol>
        </div>
        
        <div id="statusMessage" style="display:none;"></div>
        
        <div style="background-color:#f8f9fa; border:1px solid #dee2e6; border-radius:8px; padding:20px; margin-bottom:20px;">
            <h3 style="color:#4285f4; margin-bottom:15px;"><i class="fab fa-google"></i> Google ç³»çµ±ç‹€æ…‹</h3>
            <div id="syncStatusText" style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:5px; background-color:#e8f0fe;">
                <i class="fas fa-check-circle" style="color:#34a853;"></i>
                <span>Google ç³»çµ±é€£æ¥æ­£å¸¸ âœ“</span>
            </div>
        </div>
        
        <h2><i class="fas fa-envelope"></i> æ–°å¢ç´…åŒ…è¨˜éŒ„</h2>
        <form id="redPacketForm">
            <div>
                <label style="display:block; margin-bottom:8px; font-weight:600; color:#555;"><i class="fas fa-hashtag"></i> ç´…åŒ…ç·¨è™Ÿ *</label>
                <input type="number" id="packetNumber" min="1" required placeholder="è«‹è¼¸å…¥ç´…åŒ…ä¸Šçš„é‰›ç­†ç·¨è™Ÿ">
            </div>
            
            <div>
                <label style="display:block; margin-bottom:8px; font-weight:600; color:#555;"><i class="fas fa-user"></i> è³“å®¢å§“å *</label>
                <input type="text" id="guestName" required placeholder="ä¾‹å¦‚ï¼šå¼µå‰å¼· æˆ– æç¾ç²åˆå®¶">
            </div>
            
            <div>
                <label style="display:block; margin-bottom:8px; font-weight:600; color:#555;"><i class="fas fa-sticky-note"></i> å‚™è¨»</label>
                <textarea id="remark" placeholder="ä¾‹å¦‚ï¼šç´…åŒ…æœ‰ç‰¹æ®ŠèŠ±ç´‹ã€ä»£ä»–äººè´ˆé€ç­‰" rows="3"></textarea>
            </div>
            
            <!-- å·²ç§»é™¤ç¦®é‡‘é‡‘é¡è¼¸å…¥æ¬„ä½ -->
            
            <div>
                <label style="display:block; margin-bottom:8px; font-weight:600; color:#555;"><i class="fas fa-camera"></i> ç´…åŒ…ç…§ç‰‡ï¼ˆå¯é¸ï¼‰</label>
                <div class="upload-area" id="uploadArea">
                    <div style="font-size:40px; color:#e53935; margin-bottom:15px;">
                        <i class="fas fa-camera"></i>
                    </div>
                    <div style="color:#666; margin-bottom:10px; font-size:18px;">é»æ“Šä¸Šå‚³ç´…åŒ…ç…§ç‰‡ï¼ˆå¯é¸ï¼‰</div>
                    <div style="font-size:14px; color:#999;">å»ºè­°å…ˆæ‹ç´…åŒ…ä¸Šçš„é‰›ç­†ç·¨è™Ÿ</div>
                    <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none;">
                </div>
                <div id="previewContainer" style="display:flex; flex-wrap:wrap; gap:15px; margin-top:15px;"></div>
            </div>
            
            <button type="submit" class="btn" id="submitBtn">
                <i class="fas fa-cloud-upload-alt"></i> ä¿å­˜ä¸¦åŒæ­¥åˆ° Google
            </button>
            <button type="button" class="btn" id="resetBtn" style="background-color:#666; margin-top:10px;">
                <i class="fas fa-redo"></i> æ¸…é™¤é‡å¡«
            </button>
        </form>
        
        <div id="queueSection" style="display:none; margin-top:30px; border-top:1px solid #eee; padding-top:20px;">
            <h3><i class="fas fa-history"></i> å¾…åŒæ­¥è¨˜éŒ„</h3>
            <div id="queueList"></div>
        </div>
    </div>
    
    <footer style="text-align:center; margin-top:40px; color:#888; font-size:14px; padding-top:20px; border-top:1px solid #eee;">
        <p>ğŸ’ ç¥ç¦ Jason & Lala æ–°å©šå¿«æ¨‚ï¼Œæ°¸çµåŒå¿ƒï¼</p>
        <p>ğŸ’¡ æç¤ºï¼šè«‹å…ˆç”¨é‰›ç­†åœ¨ç´…åŒ…ä¸Šå¯«ç·¨è™Ÿï¼Œå†æ‹ç…§è¨˜éŒ„</p>
    </footer>

    <script>
        // é…ç½®
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyaMclDUKWA9TH2f5sc7UpYg21HN95xZUtZw7uCjb5sj0iaDpyX6B9eY8CxmqV2oyeP/exec";
        const STORAGE_KEY = 'weddingRedPacketsPending';
        
        let pendingRecords = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let currentImage = null;
        let isOnline = navigator.onLine;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            init();
        });
        
        function init() {
            // ä¸Šå‚³å€åŸŸé»æ“Šäº‹ä»¶
            document.getElementById('uploadArea').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
            
            // æ–‡ä»¶é¸æ“‡äº‹ä»¶
            document.getElementById('fileInput').addEventListener('change', handleImageUpload);
            
            // è¡¨å–®æäº¤äº‹ä»¶
            document.getElementById('redPacketForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveAndSyncRecord();
            });
            
            // é‡ç½®æŒ‰éˆ•
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            
            updateSyncStatus();
            updateQueueDisplay();
            
            // ç›£è½ç¶²çµ¡ç‹€æ…‹
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOnlineStatus);
            
            // è‡ªå‹•é‡è©¦åŒæ­¥
            if (pendingRecords.length > 0 && isOnline) {
                setTimeout(retryAllPending, 2000);
            }
        }
        
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showStatus('è«‹é¸æ“‡åœ–ç‰‡æ–‡ä»¶ï¼', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                currentImage = event.target.result;
                const previewContainer = document.getElementById('previewContainer');
                previewContainer.innerHTML = '';
                
                const previewItem = document.createElement('div');
                previewItem.style.cssText = 'width:150px; height:150px; border-radius:8px; overflow:hidden; position:relative; box-shadow:0 3px 6px rgba(0,0,0,0.1);';
                
                const img = document.createElement('img');
                img.src = currentImage;
                img.style.cssText = 'width:100%; height:100%; object-fit:cover;';
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.style.cssText = 'position:absolute; top:5px; right:5px; background-color:rgba(0,0,0,0.6); color:white; border:none; border-radius:50%; width:25px; height:25px; display:flex; align-items:center; justify-content:center;';
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    currentImage = null;
                    previewContainer.innerHTML = '';
                    document.getElementById('fileInput').value = '';
                });
                
                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);
                previewContainer.appendChild(previewItem);
            };
            
            reader.readAsDataURL(file);
        }
        
        async function saveAndSyncRecord() {
            const packetNumber = document.getElementById('packetNumber').value;
            const guestName = document.getElementById('guestName').value;
            
            if (!packetNumber || !guestName) {
                showStatus('è«‹å¡«å¯«ç´…åŒ…ç·¨è™Ÿå’Œè³“å®¢å§“åï¼', 'error');
                return;
            }
            
            const record = {
                id: Date.now(),
                packetNumber: packetNumber,
                guestName: guestName,
                remark: document.getElementById('remark').value || '',
                image: currentImage, // å¯ç‚º null
                timestamp: new Date().toLocaleString('zh-HK'),
                status: 'pending'
            };
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŒæ­¥...';
            
            try {
                if (isOnline) {
                    await syncToGoogle(record);
                    showStatus(`âœ… ç´…åŒ… #${packetNumber} å·²æˆåŠŸåŒæ­¥åˆ° Googleï¼`, 'success');
                    record.status = 'synced';
                    resetForm();
                } else {
                    pendingRecords.push(record);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(pendingRecords));
                    showStatus(`ğŸ“± ç´…åŒ… #${packetNumber} å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆé›¢ç·šæ¨¡å¼ï¼‰`, 'warning');
                    resetForm();
                }
            } catch (error) {
                record.status = 'failed';
                pendingRecords.push(record);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pendingRecords));
                showStatus('âŒ åŒæ­¥å¤±æ•—ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°éšŠåˆ—', 'error');
            }
            
            updateSyncStatus();
            updateQueueDisplay();
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> ä¿å­˜ä¸¦åŒæ­¥åˆ° Google';
        }
        
        async function syncToGoogle(record) {
            const dataToSend = {
                packetNumber: record.packetNumber,
                guestName: record.guestName,
                remark: record.remark || '',
                image: record.image // å¯ç‚º null
            };
            
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend)
            });
            
            return { success: true };
        }
        
        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = type === 'success' ? 'status-success' : type === 'error' ? 'status-error' : 'status-success';
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }
        
        function resetForm() {
            document.getElementById('redPacketForm').reset();
            currentImage = null;
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('packetNumber').focus();
        }
        
        function handleOnlineStatus() {
            isOnline = navigator.onLine;
            updateSyncStatus();
            
            if (isOnline && pendingRecords.length > 0) {
                showStatus('ç¶²çµ¡å·²é€£æ¥ï¼Œæ­£åœ¨å˜—è©¦åŒæ­¥...', 'success');
                setTimeout(retryAllPending, 1000);
            } else if (!isOnline) {
                showStatus('ç¶²çµ¡å·²æ–·é–‹ï¼Œåˆ‡æ›åˆ°é›¢ç·šæ¨¡å¼', 'warning');
            }
        }
        
        function updateSyncStatus() {
            const pendingCount = pendingRecords.filter(r => r.status === 'pending' || r.status === 'failed').length;
            const syncStatusText = document.getElementById('syncStatusText');
            
            if (!isOnline) {
                syncStatusText.innerHTML = '<i class="fas fa-wifi-slash"></i> é›¢ç·šæ¨¡å¼ - æ•¸æ“šæš«å­˜æœ¬åœ°';
                syncStatusText.style.color = '#ea4335';
            } else if (pendingCount === 0) {
                syncStatusText.innerHTML = '<i class="fas fa-check-circle"></i> æ‰€æœ‰è¨˜éŒ„å·²åŒæ­¥ âœ“';
                syncStatusText.style.color = '#0d652d';
            } else {
                syncStatusText.innerHTML = `<i class="fas fa-sync-alt"></i> ${pendingCount} æ¢è¨˜éŒ„ç­‰å¾…åŒæ­¥`;
                syncStatusText.style.color = '#ea4335';
            }
        }
        
        function updateQueueDisplay() {
            const pendingCount = pendingRecords.filter(r => r.status === 'pending' || r.status === 'failed').length;
            const queueSection = document.getElementById('queueSection');
            const queueList = document.getElementById('queueList');
            
            if (pendingCount > 0) {
                queueSection.style.display = 'block';
                queueList.innerHTML = '';
                
                pendingRecords.forEach(record => {
                    if (record.status !== 'synced') {
                        const queueItem = document.createElement('div');
                        queueItem.style.cssText = 'padding:8px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center;';
                        
                        queueItem.innerHTML = `
                            <div>
                                <strong>#${record.packetNumber}</strong> - ${record.guestName}
                                <br><small>${record.timestamp}</small>
                            </div>
                            <span style="padding:3px 8px; border-radius:12px; font-size:12px; font-weight:bold; background-color:${record.status === 'pending' ? '#fff3cd' : '#f8d7da'}; color:${record.status === 'pending' ? '#856404' : '#721c24'};">
                                ${record.status === 'pending' ? 'ç­‰å¾…åŒæ­¥' : 'åŒæ­¥å¤±æ•—'}
                            </span>
                        `;
                        
                        queueList.appendChild(queueItem);
                    }
                });
            } else {
                queueSection.style.display = 'none';
            }
        }
        
        async function retryAllPending() {
            if (pendingRecords.length === 0 || !isOnline) return;
            
            for (let i = 0; i < pendingRecords.length; i++) {
                const record = pendingRecords[i];
                if (record.status === 'pending' || record.status === 'failed') {
                    try {
                        await syncToGoogle(record);
                        record.status = 'synced';
                    } catch (error) {
                        record.status = 'failed';
                    }
                }
            }
            
            pendingRecords = pendingRecords.filter(r => r.status !== 'synced');
            localStorage.setItem(STORAGE_KEY, JSON.stringify(pendingRecords));
            
            updateSyncStatus();
            updateQueueDisplay();
        }
    </script>
</body>
</html>
