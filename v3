<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ï½Jason & Lala Weddingï½</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background-color: #f9f3f3;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e8c8c8;
            padding-bottom: 20px;
        }
        
        h1 {
            color: #c62828;
            font-size: 32px;
            margin-bottom: 10px;
            font-family: 'Segoe UI', 'Microsoft JhengHei', cursive;
        }
        
        .wedding-subtitle {
            color: #e53935;
            font-size: 20px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .subtitle {
            color: #777;
            font-size: 16px;
        }
        
        .red-envelope-icon {
            font-size: 40px;
            color: #e53935;
            margin-bottom: 15px;
        }
        
        .instructions {
            background-color: #fff8f8;
            border-left: 4px solid #e53935;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 0 8px 8px 0;
        }
        
        .instructions h3 {
            color: #c62828;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .status-section {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #e53935;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .upload-area {
            border: 2px dashed #e53935;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 15px;
        }
        
        .upload-area:hover {
            background-color: #fff8f8;
        }
        
        .upload-icon {
            font-size: 40px;
            color: #e53935;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #666;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        #fileInput {
            display: none;
        }
        
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .preview-item {
            width: 150px;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn {
            background-color: #e53935;
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }
        
        .btn:hover {
            background-color: #c62828;
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #666;
            margin-top: 10px;
        }
        
        .btn-secondary:hover {
            background-color: #555;
        }
        
        .google-config {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .google-config h3 {
            color: #4285f4;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .google-config label {
            color: #5f6368;
            font-size: 14px;
        }
        
        .google-config input {
            font-size: 14px;
            padding: 10px;
            background-color: white;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: #e8f0fe;
        }
        
        .sync-success {
            color: #0d652d;
        }
        
        .sync-fail {
            color: #ea4335;
        }
        
        .pending-queue {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        
        .queue-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .queue-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .queue-item:last-child {
            border-bottom: none;
        }
        
        .queue-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-synced {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-failed {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .quick-links {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .link-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            text-decoration: none;
            color: #333;
            transition: all 0.3s;
        }
        
        .link-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .link-card i {
            font-size: 24px;
            color: #4285f4;
            margin-bottom: 10px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: #888;
            font-size: 14px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 28px;
            }
            
            .wedding-subtitle {
                font-size: 18px;
            }
            
            .upload-text {
                font-size: 16px;
            }
            
            .quick-links {
                grid-template-columns: 1fr;
            }
        }
        
        .heart {
            color: #e53935;
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="red-envelope-icon">
                <i class="fas fa-heart heart"></i>
                <i class="fas fa-gift"></i>
                <i class="fas fa-heart heart"></i>
            </div>
            <h1>ï½Jason & Lala Weddingï½</h1>
            <div class="wedding-subtitle">å©šç¦®ç´…åŒ…è¨˜éŒ„ç³»çµ±</div>
            <p class="subtitle">è‡ªå‹•åŒæ­¥è‡³ Google Drive å’Œ Google Sheets</p>
        </header>
        
        <div class="instructions">
            <h3>âœ… ç³»çµ±å·²æº–å‚™å°±ç·’ï¼</h3>
            <p>ä½ çš„ Google Apps Script æ¸¬è©¦æˆåŠŸï¼ç¾åœ¨å¯ä»¥é–‹å§‹è¨˜éŒ„ç´…åŒ…ã€‚</p>
            <p>æ¯æ¬¡ä¿å­˜éƒ½æœƒï¼š</p>
            <ol>
                <li>è‡ªå‹•ä¿å­˜è¨˜éŒ„åˆ° Google Sheets</li>
                <li>å¦‚æœ‰åœ–ç‰‡ï¼Œè‡ªå‹•ä¸Šå‚³åˆ° Google Drive</li>
                <li>å³ä½¿æ–·ç¶²ä¹Ÿæœƒæš«å­˜æœ¬åœ°ï¼Œæœ‰ç¶²çµ¡æ™‚è‡ªå‹•åŒæ­¥</li>
            </ol>
        </div>
        
        <!-- ç‹€æ…‹é¡¯ç¤ºå€ -->
        <div id="statusMessage" class="status-section"></div>
        
        <!-- Google é…ç½®å€ -->
        <div class="google-config">
            <h3><i class="fab fa-google"></i> Google ç³»çµ±ç‹€æ…‹</h3>
            <div class="form-group">
                <label>Google Apps Script URLï¼ˆå·²è¨­å®šï¼‰</label>
                <input type="text" value="https://script.google.com/macros/s/AKfycbzt4KG-R8LEsJrEcinoXM208uCDWPgeAsMHn6SUohdHOMontpyVc319Dw9PNcpwc10ykg/exec" readonly style="background-color: #e8f5e8;">
                <small>æ­¤ URL å·²æˆåŠŸæ¸¬è©¦ï¼Œç„¡éœ€ä¿®æ”¹</small>
            </div>
            
            <div class="sync-status">
                <i class="fas fa-check-circle" style="color: #34a853;"></i>
                <span id="syncStatusText">Google ç³»çµ±é€£æ¥æ­£å¸¸ âœ“</span>
            </div>
            
            <div class="quick-links">
                <a href="https://drive.google.com/drive/folders/1FAqebbNtYRwDUWduc9tAAHkRKHLfkyBd" target="_blank" class="link-card">
                    <i class="fab fa-google-drive"></i>
                    <div>æŸ¥çœ‹ Google Drive æ–‡ä»¶å¤¾</div>
                </a>
                <a href="https://docs.google.com/spreadsheets" target="_blank" class="link-card">
                    <i class="fas fa-table"></i>
                    <div>æŸ¥çœ‹ Google Sheets è¨˜éŒ„</div>
                </a>
            </div>
        </div>
        
        <!-- ä¸»è¦è¡¨å–® -->
        <div class="form-section">
            <h2><i class="fas fa-envelope heart"></i> æ–°å¢ç´…åŒ…è¨˜éŒ„</h2>
            <form id="redPacketForm">
                <div class="form-group">
                    <label for="packetNumber"><i class="fas fa-hashtag"></i> ç´…åŒ…ç·¨è™Ÿ *</label>
                    <input type="number" id="packetNumber" min="1" required 
                           placeholder="è«‹è¼¸å…¥ç´…åŒ…ä¸Šçš„é‰›ç­†ç·¨è™Ÿ">
                </div>
                
                <div class="form-group">
                    <label for="guestName"><i class="fas fa-user"></i> è³“å®¢å§“å *</label>
                    <input type="text" id="guestName" required 
                           placeholder="ä¾‹å¦‚ï¼šå¼µå‰å¼· æˆ– æç¾ç²åˆå®¶">
                </div>
                
                <div class="form-group">
                    <label for="remark"><i class="fas fa-sticky-note"></i> å‚™è¨»</label>
                    <textarea id="remark" 
                              placeholder="ä¾‹å¦‚ï¼šç´…åŒ…æœ‰ç‰¹æ®ŠèŠ±ç´‹ã€ä»£ä»–äººè´ˆé€ç­‰"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="amount"><i class="fas fa-money-bill-wave"></i> ç¦®é‡‘é‡‘é¡ (HK$)</label>
                    <input type="text" id="amount" 
                           placeholder="ç¨å¾Œè¼¸å…¥ï¼ˆä¾‹å¦‚ï¼š1000ï¼‰">
                </div>
                
                <!-- ä¿®æ”¹ç‚ºå¯é¸çš„åœ–ç‰‡ä¸Šå‚³ -->
                <div class="form-group">
                    <label><i class="fas fa-camera"></i> ç´…åŒ…ç…§ç‰‡ (å¯é¸)</label>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div class="upload-text">é»æ“Šä¸Šå‚³ç´…åŒ…ç…§ç‰‡ (å¯é¸)</div>
                        <div style="font-size: 14px; color: #999;">å»ºè­°å…ˆæ‹ç´…åŒ…ä¸Šçš„é‰›ç­†ç·¨è™Ÿ</div>
                        <input type="file" id="fileInput" accept="image/*" capture="environment">
                    </div>
                    <div class="preview-container" id="previewContainer"></div>
                </div>
                
                <button type="submit" class="btn" id="submitBtn">
                    <i class="fas fa-cloud-upload-alt"></i> ä¿å­˜ä¸¦åŒæ­¥åˆ° Google
                </button>
                <button type="button" class="btn btn-secondary" id="resetBtn">
                    <i class="fas fa-redo"></i> æ¸…é™¤é‡å¡«
                </button>
            </form>
        </div>
        
        <!-- å¾…åŒæ­¥éšŠåˆ— -->
        <div class="pending-queue" id="queueSection" style="display: none;">
            <h3><i class="fas fa-history"></i> å¾…åŒæ­¥è¨˜éŒ„</h3>
            <p style="color: #666; margin-bottom: 10px;">ä»¥ä¸‹è¨˜éŒ„ç­‰å¾…åŒæ­¥åˆ° Google</p>
            <div class="queue-list" id="queueList"></div>
            <button type="button" class="btn btn-secondary" id="retrySyncBtn" style="margin-top: 15px;">
                <i class="fas fa-sync-alt"></i> ç«‹å³é‡è©¦åŒæ­¥
            </button>
        </div>
    </div>
    
    <footer>
        <p>ğŸ’ ç¥ç¦ Jason & Lala æ–°å©šå¿«æ¨‚ï¼Œæ°¸çµåŒå¿ƒï¼</p>
        <p>ğŸ’¡ æç¤ºï¼šè«‹å…ˆç”¨é‰›ç­†åœ¨ç´…åŒ…ä¸Šå¯«ç·¨è™Ÿï¼Œå†æ‹ç…§è¨˜éŒ„</p>
        <p>ç³»çµ±å·²é€£æ¥ Googleï¼Œæ•¸æ“šæœƒè‡ªå‹•å‚™ä»½åˆ°é›²ç«¯</p>
    </footer>

    <script>
        // é…ç½® - ä½¿ç”¨ä½ çš„æ–° Web App URL
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzt4KG-R8LEsJrEcinoXM208uCDWPgeAsMHn6SUohdHOMontpyVc319Dw9PNcpwc10ykg/exec";
        const STORAGE_KEY = 'weddingRedPacketsPending';
        
        // å…¨å±€è®Šé‡
        let pendingRecords = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let currentImage = null;
        let isOnline = navigator.onLine;
        
        // DOMå…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const form = document.getElementById('redPacketForm');
        const submitBtn = document.getElementById('submitBtn');
        const resetBtn = document.getElementById('resetBtn');
        const statusMessage = document.getElementById('statusMessage');
        const syncStatusText = document.getElementById('syncStatusText');
        const queueSection = document.getElementById('queueSection');
        const queueList = document.getElementById('queueList');
        const retrySyncBtn = document.getElementById('retrySyncBtn');
        
        // åˆå§‹åŒ–
        function init() {
            updateSyncStatus();
            updateQueueDisplay();
            
            // ç›£è½ç¶²çµ¡ç‹€æ…‹
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOnlineStatus);
            
            // è‡ªå‹•é‡è©¦åŒæ­¥ï¼ˆå¦‚æœæœ‰å¾…åŒæ­¥è¨˜éŒ„ï¼‰
            if (pendingRecords.length > 0 && isOnline) {
                setTimeout(() => retryAllPending(), 2000);
            }
        }
        
        init();
        
        // äº‹ä»¶ç›£è½
        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', handleImageUpload);
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveAndSyncRecord();
        });
        
        resetBtn.addEventListener('click', resetForm);
        
        retrySyncBtn.addEventListener('click', retryAllPending);
        
        // è™•ç†åœ–ç‰‡ä¸Šå‚³
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showStatus('è«‹é¸æ“‡åœ–ç‰‡æ–‡ä»¶ï¼', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                currentImage = event.target.result;
                previewContainer.innerHTML = '';
                
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                
                const img = document.createElement('img');
                img.src = currentImage;
                img.alt = 'ç´…åŒ…ç…§ç‰‡';
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentImage = null;
                    previewContainer.innerHTML = '';
                    fileInput.value = '';
                });
                
                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);
                previewContainer.appendChild(previewItem);
            };
            
            reader.readAsDataURL(file);
        }
        
        // ä¿å­˜ä¸¦åŒæ­¥è¨˜éŒ„ - ç°¡åŒ–ç‰ˆæœ¬
        async function saveAndSyncRecord() {
            const packetNumber = document.getElementById('packetNumber').value;
            const guestName = document.getElementById('guestName').value;
            const remark = document.getElementById('remark').value;
            const amount = document.getElementById('amount').value;
            
            if (!packetNumber || !guestName) {
                showStatus('è«‹å¡«å¯«ç´…åŒ…ç·¨è™Ÿå’Œè³“å®¢å§“åï¼', 'error');
                return;
            }
            
            // å‰µå»ºè¨˜éŒ„å°è±¡
            const record = {
                id: Date.now(),
                packetNumber: packetNumber,
                guestName: guestName,
                remark: remark,
                amount: amount,
                timestamp: new Date().toLocaleString('zh-HK'),
                status: 'pending'
            };
            
            // å¦‚æœæœ‰åœ–ç‰‡æ‰æ·»åŠ åœ–ç‰‡å­—æ®µ
            if (currentImage) {
                record.image = currentImage;
            }
            
            // ç¦ç”¨æäº¤æŒ‰éˆ•
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŒæ­¥...';
            
            try {
                if (isOnline) {
                    // åœ¨ç·šï¼šç«‹å³åŒæ­¥åˆ° Google
                    const result = await syncToGoogle(record);
                    
                    if (result && result.success) {
                        showStatus(`âœ… ç´…åŒ… #${packetNumber} å·²æˆåŠŸåŒæ­¥åˆ° Googleï¼`, 'success');
                        record.status = 'synced';
                        resetForm();
                    } else {
                        throw new Error('åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡');
                    }
                } else {
                    // é›¢ç·šï¼šä¿å­˜åˆ°æœ¬åœ°éšŠåˆ—
                    pendingRecords.push(record);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(pendingRecords));
                    showStatus(`ğŸ“± ç´…åŒ… #${packetNumber} å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆé›¢ç·šæ¨¡å¼ï¼‰`, 'warning');
                    resetForm();
                }
            } catch (error) {
                // åŒæ­¥å¤±æ•—ï¼šä¿å­˜åˆ°å¾…åŒæ­¥éšŠåˆ—
                record.status = 'failed';
                pendingRecords.push(record);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pendingRecords));
                showStatus(`âŒ åŒæ­¥å¤±æ•—ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°éšŠåˆ—`, 'error');
                console.error('åŒæ­¥éŒ¯èª¤:', error);
            }
            
            // æ›´æ–°é¡¯ç¤º
            updateSyncStatus();
            updateQueueDisplay();
            
            // æ¢å¾©æäº¤æŒ‰éˆ•
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> ä¿å­˜ä¸¦åŒæ­¥åˆ° Google';
        }
        
        // åŒæ­¥åˆ° Google
        async function syncToGoogle(record) {
            const dataToSend = {
                packetNumber: record.packetNumber,
                guestName: record.guestName,
                remark: record.remark || '',
                amount: record.amount || ''
            };
            
            // å¦‚æœæœ‰åœ–ç‰‡æ‰ç™¼é€åœ–ç‰‡
            if (record.image) {
                dataToSend.image = record.image;
            }
            
            // ä½¿ç”¨ä½ çš„æ–° Google Apps Script URL
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend)
            });
            
            return { success: true };
        }
        
        // é‡è©¦æ‰€æœ‰å¾…åŒæ­¥è¨˜éŒ„
        async function retryAllPending() {
            if (pendingRecords.length === 0) {
                showStatus('æ²’æœ‰å¾…åŒæ­¥çš„è¨˜éŒ„', 'info');
                return;
            }
            
            if (!isOnline) {
                showStatus('ç¶²çµ¡æœªé€£æ¥ï¼Œç„¡æ³•åŒæ­¥', 'error');
                return;
            }
            
            retrySyncBtn.disabled = true;
            retrySyncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŒæ­¥ä¸­...';
            
            let successCount = 0;
            
            for (let i = 0; i < pendingRecords.length; i++) {
                const record = pendingRecords[i];
                if (record.status === 'pending' || record.status === 'failed') {
                    try {
                        await syncToGoogle(record);
                        record.status = 'synced';
                        successCount++;
                    } catch (error) {
                        record.status = 'failed';
                    }
                }
            }
            
            // éæ¿¾å·²åŒæ­¥çš„è¨˜éŒ„
            pendingRecords = pendingRecords.filter(r => r.status !== 'synced');
            localStorage.setItem(STORAGE_KEY, JSON.stringify(pendingRecords));
            
            // æ›´æ–°é¡¯ç¤º
            updateSyncStatus();
            updateQueueDisplay();
            
            if (successCount > 0) {
                showStatus(`âœ… æˆåŠŸåŒæ­¥ ${successCount} æ¢è¨˜éŒ„`, 'success');
            }
            
            retrySyncBtn.disabled = false;
            retrySyncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> ç«‹å³é‡è©¦åŒæ­¥';
        }
        
        // æ›´æ–°åŒæ­¥ç‹€æ…‹é¡¯ç¤º
        function updateSyncStatus() {
            const pendingCount = pendingRecords.filter(r => r.status === 'pending' || r.status === 'failed').length;
            
            if (!isOnline) {
                syncStatusText.textContent = 'é›¢ç·šæ¨¡å¼ - æ•¸æ“šæš«å­˜æœ¬åœ°';
                syncStatusText.className = 'sync-fail';
            } else if (pendingCount === 0) {
                syncStatusText.textContent = 'æ‰€æœ‰è¨˜éŒ„å·²åŒæ­¥ âœ“';
                syncStatusText.className = 'sync-success';
            } else {
                syncStatusText.textContent = `${pendingCount} æ¢è¨˜éŒ„ç­‰å¾…åŒæ­¥`;
                syncStatusText.className = 'sync-fail';
            }
        }
        
        // æ›´æ–°éšŠåˆ—é¡¯ç¤º
        function updateQueueDisplay() {
            const pendingCount = pendingRecords.filter(r => r.status === 'pending' || r.status === 'failed').length;
            
            if (pendingCount > 0) {
                queueSection.style.display = 'block';
                queueList.innerHTML = '';
                
                pendingRecords.forEach(record => {
                    if (record.status !== 'synced') {
                        const queueItem = document.createElement('div');
                        queueItem.className = 'queue-item';
                        
                        const info = document.createElement('div');
                        info.innerHTML = `
                            <strong>#${record.packetNumber}</strong> - ${record.guestName}
                            <br><small>${record.timestamp}</small>
                        `;
                        
                        const status = document.createElement('span');
                        status.className = `queue-status status-${record.status}`;
                        status.textContent = record.status === 'pending' ? 'ç­‰å¾…åŒæ­¥' : 'åŒæ­¥å¤±æ•—';
                        
                        queueItem.appendChild(info);
                        queueItem.appendChild(status);
                        queueList.appendChild(queueItem);
                    }
                });
            } else {
                queueSection.style.display = 'none';
            }
        }
        
        // é¡¯ç¤ºç‹€æ…‹æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-section status-${type}`;
            statusMessage.style.display = 'block';
            
            // 3ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }
        
        // é‡ç½®è¡¨å–®
        function resetForm() {
            form.reset();
            currentImage = null;
            previewContainer.innerHTML = '';
            fileInput.value = '';
            
            // é‡ç½®å¾Œèšç„¦åˆ°ç·¨è™Ÿè¼¸å…¥æ¡†
            document.getElementById('packetNumber').focus();
        }
        
        // è™•ç†ç¶²çµ¡ç‹€æ…‹è®ŠåŒ–
        function handleOnlineStatus() {
            isOnline = navigator.onLine;
            updateSyncStatus();
            
            if (isOnline && pendingRecords.length > 0) {
                showStatus('ç¶²çµ¡å·²é€£æ¥ï¼Œæ­£åœ¨å˜—è©¦åŒæ­¥...', 'success');
                setTimeout(() => retryAllPending(), 1000);
            } else if (!isOnline) {
                showStatus('ç¶²çµ¡å·²æ–·é–‹ï¼Œåˆ‡æ›åˆ°é›¢ç·šæ¨¡å¼', 'warning');
            }
        }
    </script>
</body>
</html>
